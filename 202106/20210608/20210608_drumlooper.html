
<!DOCTYPE html>
<html>
<head>
	<title>drumlooper</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
 
</head>
<body>
<form name="myForm">
<hr>
<label> mute <input type="checkbox" name="muteKick" id="muteKick" value="muteKick"></label> 音量:<select name="volumeKick" id="volumeKick">
    <option value="-Infinity">-Infinity (off)</option>
    <option value="-30">-30 (quieter)</option>
    <option value="-25">-25</option>
    <option value="-20">-20</option>
    <option value="-15" selected>-15</option>
    <option value="-10">-10</option>
    <option value="-5">-5</option>
    <option value="0">0 (louder)</option>
</select><br>
リズムパターン(Kick):<select  name="someRhythmsKD" id="someRhythmsKD">
<option value="24,24,24,24,24,24,24,24">quarter notes</option>
<option value="48,48,48,48" selected>half notes (1, 3)</option>
<option value="36,12,36,12,36,12,36,12">dotted quarter, eighth</option>
<option value="12,36,12,36,12,36,12,36">1, 1&, 3, 3&</option>
<option value="36,24,24,12,36,24,24,12">1, 2&, 3&, 4&</option>
<option value="36,36,48,24,48">3-2 clave</option>
<option value="-24,24,48,36,36,24">2-3 clave</option>
<option value="24,12,24,12,36,12,24,48">Bo Diddley</option>
</select><hr>

<label> mute <input type="checkbox" name="muteSnare" id="muteSnare" value="muteSnare"></label> 音量:<select name="volumeSnare" id="volumeSnare">
    <option value="-Infinity">-Infinity (off)</option>
    <option value="-30">-30 (quieter)</option>
    <option value="-25">-25</option>
    <option value="-20">-20</option>
    <option value="-15" selected>-15</option>
    <option value="-10">-10</option>
    <option value="-5">-5</option>
    <option value="0">0 (louder)</option>
</select><br>
リズムパターン(Snare):<select  name="someRhythmsSD" id="someRhythmsSD">
<option value="24,24,24,24,24,24,24,24">quarter notes</option>
<option value="-24,24,-24,24,-24,24,-24,24" selected>back beat (2, 4)</option>
<option value="-12,24,36,24,-12,24,36,24">1&, 2&, 4</option>
<option value="-12,24,24,24,12,-12,24,24,24,12">1&, 2&, 3&, 4&</option>
<option value="-24,18,6,-24,24,-24,18,6,-24,24">2, 2&a, 4</option>
<option value="-12,6,6,-12,6,6,-12,12,-12,12,-12,6,6,-12,6,6,-12,12,-12,12">1&,1&a,2&,2&a,3&,4&</option>
<option value="18,6,6,12,6,18,6,6,12,6">dotted eighth, sixteenth, sixteenth, eighth, sixteen</option>
<option value="36,36,48,24,48">3-2 clave</option>
<option value="-24,24,48,36,36,24">2-3 clave</option>
<option value="24,12,24,12,24,-12,12,24,24,-24">Bo Diddley</option>
</select><hr>

<label> mute <input type="checkbox" name="muteConga" id="muteConga" value="muteSnare"></label> 音量:<select name="volumeConga" id="volumeConga">
    <option value="-Infinity">-Infinity (off)</option>
    <option value="-30">-30 (quieter)</option>
    <option value="-25">-25</option>
    <option value="-20">-20</option>
    <option value="-15" selected>-15</option>
    <option value="-10">-10</option>
    <option value="-5">-5</option>
    <option value="0">0 (louder)</option>
</select><br>
リズムパターン(Conga):<select  name="someRhythmsCD" id="someRhythmsCD">
<option value="24,24,24,24,24,24,24,24">quarter notes</option>
<option value="12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12">eighth notes</option>
<option value="24,12,12,24,12,12,24,12,12,24,12,12">1, 2, 2&, 3, 4, 4&</option>
<option value="-24,24,-24,12,12,-24,24,-24,12,12" selected>2, 4, 4&</option>
<option value="6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6">sixteenth, eighth, sixteenth</option>
<option value="6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6">sixteenths</option>
<option value="18,6,6,12,6,18,6,6,12,6,18,6,6,12,6,18,6,6,12,6">dotted eighth, sixteenth, sixteenth, eighth, sixteen</option>
<option value="36,36,48,24,48">3-2 clave</option>
<option value="-24,24,48,36,36,24">2-3 clave</option>
<option value="24,12,24,12,24,-12,12,24,24,-24">Bo Diddley</option>
</select><hr>

<label> mute <input type="checkbox" name="muteHiHat" id="muteHiHat" value="muteHiHat"></label> 音量:<select name="volumeHiHat" id="volumeHiHat">
    <option value="-Infinity">-Infinity (off)</option>
    <option value="-30">-30 (quieter)</option>
    <option value="-25">-25</option>
    <option value="-20">-20</option>
    <option value="-15" selected>-15</option>
    <option value="-10">-10</option>
    <option value="-5">-5</option>
    <option value="0">0 (louder)</option><br>
</select><br>
リズムパターン(HiHat):<select  name="someRhythmsHH" id="someRhythmsHH">
<option value="24,24,24,24,24,24,24,24">quarter notes</option>
<option value="12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12" selected>eighth notes</option>
<option value="12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6">eighth, two sixteenths</option>
<option value="6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12">two sixteenths, eighth</option>
<option value="6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6,6,12,6">sixteenth, eighth, sixteenth</option>
<option value="6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6">sixteenths</option>
<option value="18,6,6,12,6,18,6,6,12,6,18,6,6,12,6,18,6,6,12,6">dotted eighth, sixteenth, sixteenth, eighth, sixteen</option>
<option value="36,36,48,24,24,-24">3-2 clave</option>
<option value="-24,24,48,36,36,24">2-3 clave</option>
<option value="24,12,24,12,24,-12,12,24,24,-24">Bo Diddley</option>
</select>
</p>
<p>
<input type="button" class="playButton" VALUE="Play Rhythms" id="buttonDrumMachine">

 tempo:<select name="tempo" id="tempo"  onchange="updateTempo()">
    <option value=60>60</option>
    <option value=70>70</option>
    <option value=80>80</option>
    <option value=90>90</option>
    <option value=100 selected>100</option>
    <option value=110>110</option>
    <option value=120>120</option>
    <option value=130>130</option>
    <option value=140>140</option>
    <option value=160>160</option>
    <option value=180>180</option>
    <option value=200>200</option>
</select>
<input type="button" class="stopButton" VALUE="Stop" onclick="stopIt()"> (click the stop button between plays)
</p>
</form>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>   

<script type="text/javascript" src="https://www.guitarland.com/javascripts/Tone.js"></script>
<!--    <script type="text/javascript" src="https://tonejs.github.io/build/Tone.js"></script> -->

<script type="text/javascript" src="https://www.guitarland.com/javascripts/StartAudioContext.js"></script>

<script src="https://www.guitarland.com/javascripts/Rhythm.js"></script>

<script>
// 参考：https://www.guitarland.com/MusicTheoryWithToneJS/PlayRhythms.html
function stopIt(){
Tone.Transport.stop();
Tone.Transport.cancel(0);
if(kick) {
   kick.dispose();
   kick = null;
}
if(snare) {
   snare.dispose();
   snare = null;
}
if(conga) {
   conga.dispose();
   conga = null;
}
}

function updateTempo()  {
var tempo = document.myForm.tempo.value;
Tone.Transport.bpm.value = tempo   
}


function updateVolume()  {
kick.volume.value = document.myForm.volumeKick.value;
snare.volume.value = document.myForm.volumeSnare.value;
conga.volume.value = document.myForm.volumeConga.value;
closedHiHat.volume.value = document.myForm.volumeHiHat.value;
}

function updateMute()  {
var muteKickBoolean = document.myForm.muteKick.checked;
var muteSnareBoolean = document.myForm.muteSnare.checked;
var muteCongaBoolean = document.myForm.muteConga.checked;
var muteHiHatBoolean = document.myForm.muteHiHat.checked;

kickPart.mute = muteKickBoolean ? true: false;
snarePart.mute = muteSnareBoolean ? true: false;
congaPart.mute = muteCongaBoolean? true: false;
hiHatPart.mute = muteHiHatBoolean? true: false;
}
var kick = null;
var snare = null;
var conga = null;
//	KICK
function makeKick() {
var kick = new Tone.MembraneSynth({
    "volume" : -1,
    "envelope" : {
        "sustain" : 0.1,
        "attack" : 0.005,
        "decay" : 0.8
    },
    "octaves" : 5
}).toMaster();
//	}).toDestination();
return kick;
}



//	SNARE
function makeSnare() {
var snare = new Tone.NoiseSynth({
    "volume" : -7,
    "envelope" : {
        "attack" : 0.001,
        "decay" : 0.5,
        "sustain" : 0.01,
        "release" : 0.02
    },
    "filterEnvelope" : {
        "attack" : 0.001,
        "decay" : 0.1,
        "sustain" : 0.01,
        "release" : 0.2
    }
}).toMaster();
//	}).toDestination();
return snare;
}

//  CONGA
function makeConga() {
var conga = new Tone.MembraneSynth({
    "pitchDecay" : 0.008,
    "octaves" : 2,
    "envelope" : {
        "attack" : 0.0006,
        "decay" : 0.5,
        "sustain" : 0
    }
}).toMaster();
//	}).toDestination();
return conga;
}

var lowPass = new Tone.Filter({
    "frequency": 14000,
}).toMaster();
//	}).toDestination();

//  CLOSED HIHAT
var closedHiHat = new Tone.NoiseSynth({
    "volume" : -14,
    "filter": {
        "Q": 1
    },
    "envelope": {
        "attack": 0.01,
        "decay": 0.15
    },
    "filterEnvelope": {
        "attack": 0.01,
        "decay": 0.03,
        "baseFrequency": 4000,
        "octaves": -2.5,
        "exponent": 4,

    }
}).connect(lowPass);

function getCongaPitches(patternString, corePitchesArray) {
    var patternArray = patternString.split(',');
    var count = 0;
    var pitches = [];
    for(let i=0; i<patternArray.length; i++) {
        if( parseInt(patternArray[i]) > 0) {
            pitches.push(corePitchesArray[count % corePitchesArray.length])
            count++;
        }
    }
    return pitches;
}

var kickPart;
var snarePart;
var congaPart;
var hiHatPart;

function DrumMachine() {
    console.log("DrumMachine");
// create kick drum part
    var kickMenu = document.getElementById("someRhythmsKD");
    var kickPattern = kickMenu.options[kickMenu.selectedIndex].value;

    Rhythm.setOnlyDurationString(kickPattern, 1);
    var kickRhythm = Rhythm.getTransportCode(1);
    console.log("kickRhythm="+kickRhythm);
    if(!kick) {
        kick = makeKick();
    }
    kickPart = new Tone.Part(function(time, value){
        kick.triggerAttackRelease("A2", "8n", time)
    }, kickRhythm ).start(0, "1:0");
//---------------------------------------------------

// create snare drum part
    var snareMenu = document.getElementById("someRhythmsSD");
    var snarePattern = snareMenu.options[snareMenu.selectedIndex].value;

    Rhythm.setOnlyDurationString(snarePattern, 2);
    var snareRhythm = Rhythm.getTransportCode(2);
    console.log("snareRhythm="+snareRhythm);
    if(!snare) {
        snare = makeSnare();
    }
    snarePart = new Tone.Part(function(time){
        snare.triggerAttack(time)
    }, snareRhythm ).start(0, "1:0");
//------------------------------------------------*/

// create conga drum part
    var congaMenu = document.getElementById("someRhythmsCD");
    var congaPattern = congaMenu.options[congaMenu.selectedIndex].value;
    var congaTones = ["G4","Ab4","F#4"]; //,"G4","Ab4","F#4","G4","Ab4","F#4","G4","Ab4","F#4","G4","Ab4","F#4"];
    var congaPitches = getCongaPitches(congaPattern, congaTones);
    
    Rhythm.setDurationString(congaPattern, congaPitches, 3);
    var congaMelody = Rhythm.getMelodyWithRhythm(3);

    var congaRhythm = Rhythm.getTransportCode(3);

    console.log("congaRhythm="+congaRhythm);
    console.log("congaMelody="+congaMelody);
    if(!conga) {
        conga = makeConga();
    }
    congaPart = new Tone.Part(function(time, note){
        conga.triggerAttackRelease(note, "8n", time)
    }, congaMelody ).start(0, "1:0");

// create hihat part
    var hiHatMenu = document.getElementById("someRhythmsHH");
    var hiHatPattern = hiHatMenu.options[hiHatMenu.selectedIndex].value;

    Rhythm.setOnlyDurationString(hiHatPattern, 4);
    var hiHatRhythm = Rhythm.getTransportCode(4);

//        var hiHatRhythm = Rhythm.createTransportTimeCode(hiHatArray);
    console.log("hiHatRhythm="+hiHatRhythm);

    hiHatPart = new Tone.Part(function(time){
        closedHiHat.triggerAttack(time);
    }, hiHatRhythm).start(0, "1:0");

    updateVolume();

    //TRANSPORT
    updateMute();
    Tone.Transport.loopStart = "0:0";
    Tone.Transport.loopEnd = "2:0";
    Tone.Transport.loop = true;
    var tempo = document.myForm.tempo.value;
    Tone.Transport.bpm.value = tempo   
    Tone.Transport.start("+0.1");


}
    // -----
    var mybuttonDrumMachine = document.getElementById("buttonDrumMachine");

    // onclick bindings
    mybuttonDrumMachine.onclick = DrumMachine;

    // onchange bindings
    var myMuteKickCheckbox = document.getElementById("muteKick");
    var myMuteSnareCheckbox = document.getElementById("muteSnare");
    var myMuteCongaCheckbox = document.getElementById("muteConga");
    var myMuteHiHatCheckbox = document.getElementById("muteHiHat");
    
    myMuteKickCheckbox.onchange = updateMute;
    myMuteSnareCheckbox.onchange = updateMute;
    myMuteCongaCheckbox.onchange = updateMute;
    myMuteHiHatCheckbox.onchange = updateMute;

    var myVolumeKickMenu = document.getElementById("volumeKick");
    var myVolumeSnareMenu = document.getElementById("volumeSnare");
    var myVolumeCongaMenu = document.getElementById("volumeConga");
    var myVolumeHiHatMenu = document.getElementById("volumeHiHat");
    
    myVolumeKickMenu.onchange = updateVolume;
    myVolumeSnareMenu.onchange = updateVolume;
    myVolumeCongaMenu.onchange = updateVolume;
    myVolumeHiHatMenu.onchange = updateVolume;
    
    var myDelayMenu = document.getElementById("delay");
//    myDelayMenu.onchange = updateDelayTime;
    
</script>
</body>
</html>